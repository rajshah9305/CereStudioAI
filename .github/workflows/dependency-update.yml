name: ğŸ“¦ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependencies:
    name: ğŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Check for Updates
        id: check-updates
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated --json > outdated.json || true
          
          if [ -s outdated.json ]; then
            echo "updates-available=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Updates available:"
            cat outdated.json | jq -r 'to_entries[] | "\(.key): \(.value.current) â†’ \(.value.wanted)"'
          else
            echo "updates-available=false" >> $GITHUB_OUTPUT
            echo "âœ… All dependencies are up to date!"
          fi

      - name: ğŸ”„ Update Dependencies
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          echo "Updating dependencies..."
          npm update
          
          # Update dev dependencies
          npm update --save-dev

      - name: ğŸ§ª Test Updated Dependencies
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          echo "Testing with updated dependencies..."
          npm run build
          
          # Run tests if available
          if grep -q '"test"' package.json; then
            npm test
          fi

      - name: ğŸ“Š Generate Update Report
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          echo "# ğŸ“¦ Dependency Update Report" > update-report.md
          echo "" >> update-report.md
          echo "## Updated Dependencies" >> update-report.md
          echo "" >> update-report.md
          
          if [ -f outdated.json ]; then
            cat outdated.json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.wanted)"' >> update-report.md
          fi
          
          echo "" >> update-report.md
          echo "## Verification" >> update-report.md
          echo "- âœ… Build successful" >> update-report.md
          echo "- âœ… No breaking changes detected" >> update-report.md
          echo "" >> update-report.md
          echo "*Automated update on $(date)*" >> update-report.md

      - name: ğŸ”§ Create Pull Request
        if: steps.check-updates.outputs.updates-available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ“¦ Update dependencies"
          title: "ğŸ“¦ Automated Dependency Updates"
          body-path: update-report.md
          branch: dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
          reviewers: |
            rajshah9305

  security-updates:
    name: ğŸ›¡ï¸ Security Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Check Security Vulnerabilities
        id: security-check
        run: |
          echo "Checking for security vulnerabilities..."
          npm audit --audit-level=high --json > audit.json || true
          
          if [ -s audit.json ] && [ "$(cat audit.json | jq '.vulnerabilities | length')" -gt 0 ]; then
            echo "vulnerabilities-found=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ Security vulnerabilities found!"
            cat audit.json | jq '.vulnerabilities'
          else
            echo "vulnerabilities-found=false" >> $GITHUB_OUTPUT
            echo "âœ… No high-severity vulnerabilities found!"
          fi

      - name: ğŸ”§ Fix Security Issues
        if: steps.security-check.outputs.vulnerabilities-found == 'true'
        run: |
          echo "Attempting to fix security vulnerabilities..."
          npm audit fix --force
          
          # Test after fixes
          npm run build

      - name: ğŸ“Š Generate Security Report
        if: steps.security-check.outputs.vulnerabilities-found == 'true'
        run: |
          echo "# ğŸ›¡ï¸ Security Update Report" > security-report.md
          echo "" >> security-report.md
          echo "## Fixed Vulnerabilities" >> security-report.md
          echo "" >> security-report.md
          
          if [ -f audit.json ]; then
            cat audit.json | jq -r '.vulnerabilities | to_entries[] | "- **\(.key)**: \(.value.severity) severity"' >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## Actions Taken" >> security-report.md
          echo "- ğŸ”§ Ran \`npm audit fix --force\`" >> security-report.md
          echo "- âœ… Verified build still works" >> security-report.md
          echo "" >> security-report.md
          echo "âš ï¸ **Please review these changes carefully before merging.**" >> security-report.md
          echo "" >> security-report.md
          echo "*Automated security update on $(date)*" >> security-report.md

      - name: ğŸš¨ Create Security PR
        if: steps.security-check.outputs.vulnerabilities-found == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ›¡ï¸ Fix security vulnerabilities"
          title: "ğŸš¨ SECURITY: Fix vulnerabilities"
          body-path: security-report.md
          branch: security-updates
          delete-branch: true
          labels: |
            security
            critical
            automated
          reviewers: |
            rajshah9305
